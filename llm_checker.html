<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLMå®Ÿé¨“çµæœãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .experiment-section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }

      .experiment-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
      }

      .experiment-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
      }

      .experiment-item {
        background-color: #e8f5e8;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s;
      }

      .experiment-item:hover {
        background-color: #d4edda;
      }

      .experiment-item.selected {
        border-color: #4caf50;
        background-color: #d4edda;
      }

      .experiment-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .experiment-input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .progress-fill {
        height: 100%;
        background-color: #4caf50;
        transition: width 0.3s ease;
      }

      .progress-text {
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .item-container {
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        background-color: #fafafa;
      }

      .section-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 5px;
      }

      .object-caption {
        background-color: #e8f5e8;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 4px solid #4caf50;
      }

      .conversation {
        margin-bottom: 15px;
      }

      .human-message {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        border-left: 4px solid #2196f3;
      }

      .gpt-message {
        background-color: #fff3e0;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        border-left: 4px solid #ff9800;
      }

      .role-label {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .controls {
        text-align: center;
        margin-top: 30px;
      }

      .btn {
        padding: 12px 25px;
        margin: 0 10px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .btn-correct {
        background-color: #4caf50;
        color: white;
      }

      .btn-correct:hover {
        background-color: #45a049;
      }

      .btn-wrong {
        background-color: #f44336;
        color: white;
      }

      .btn-wrong:hover {
        background-color: #da190b;
      }

      .btn-skip {
        background-color: #ffc107;
        color: black;
      }

      .btn-skip:hover {
        background-color: #e0a800;
      }

      .btn-save {
        background-color: #2196f3;
        color: white;
      }

      .btn-save:hover {
        background-color: #0b7dda;
      }

      .btn-quit {
        background-color: #9e9e9e;
        color: white;
      }

      .btn-quit:hover {
        background-color: #757575;
      }

      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      .hidden {
        display: none;
      }

      .start-controls {
        text-align: center;
        margin-top: 20px;
      }

      .start-input {
        padding: 10px;
        font-size: 16px;
        margin: 0 10px;
        width: 100px;
      }

      .keyboard-hint {
        margin-top: 20px;
        text-align: center;
        font-size: 14px;
        color: #666;
      }

      .results-summary {
        background-color: #e8f5e8;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: center;
      }

      .loading {
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: #666;
      }

      .status-info {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #2196f3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¤– LLMå®Ÿé¨“çµæœãƒã‚§ãƒƒã‚«ãƒ¼</h1>

      <div id="loading-section" class="loading">
        ğŸ“‚ test.json ã‚’èª­ã¿è¾¼ã¿ä¸­...
      </div>

      <div id="experiment-section" class="experiment-section hidden">
        <div class="experiment-title">ğŸ“‹ å®Ÿé¨“ç®¡ç†</div>

        <div class="experiment-list" id="experiment-list">
          <!-- å®Ÿé¨“ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>

        <div class="experiment-controls">
          <input
            type="text"
            id="new-experiment-name"
            class="experiment-input"
            placeholder="æ–°ã—ã„å®Ÿé¨“å"
          />
          <button class="btn-small btn-correct" onclick="createExperiment()">
            å®Ÿé¨“ä½œæˆ
          </button>
          <button class="btn-small btn-danger" onclick="deleteExperiment()">
            é¸æŠã—ãŸå®Ÿé¨“ã‚’å‰Šé™¤
          </button>
        </div>
      </div>

      <div id="data-loaded-section" class="hidden">
        <div class="status-info">
          <div>
            <strong>å®Ÿé¨“å:</strong> <span id="current-experiment-name"></span>
          </div>
          <div>
            <strong>ç·ãƒ‡ãƒ¼ã‚¿æ•°:</strong> <span id="total-items">0</span>ä»¶
          </div>
          <div>
            <strong>ãƒã‚§ãƒƒã‚¯æ¸ˆã¿:</strong> <span id="checked-items">0</span>ä»¶
          </div>
        </div>

        <div class="progress-text" id="progress-text">å®Ÿé¨“ã‚’æº–å‚™ä¸­...</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="start-controls" id="start-controls">
          <div style="margin-bottom: 10px">
            <label for="seed-input">ã‚·ãƒ¼ãƒ‰å€¤:</label>
            <input
              type="number"
              id="seed-input"
              class="start-input"
              value="12345"
            />
            <button class="btn btn-skip" onclick="reshuffle()">
              å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            </button>
          </div>
          <div>
            <label for="start-input"
              >é–‹å§‹ä½ç½® (1-<span id="total-items-2">0</span>):</label
            >
            <input
              type="number"
              id="start-input"
              class="start-input"
              min="1"
              value="1"
            />
            <button class="btn btn-correct" onclick="startChecking()">
              é–‹å§‹
            </button>
          </div>
        </div>
      </div>

      <div id="checker-section" class="hidden">
        <div class="item-container" id="item-container">
          <div class="section-title">ğŸ“ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜</div>
          <div id="object-captions"></div>

          <div class="section-title">ğŸ’¬ ä¼šè©±</div>
          <div id="conversations"></div>
        </div>

        <div class="controls">
          <button class="btn btn-correct" onclick="evaluate('correct')">
            âœ… æ­£ã—ã„ (C)
          </button>
          <button class="btn btn-wrong" onclick="evaluate('wrong')">
            âŒ é–“é•ã„ (W)
          </button>
          <button class="btn btn-skip" onclick="evaluate('skip')">
            â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (S)
          </button>
          <button class="btn btn-save" onclick="saveResults()">ğŸ’¾ ä¿å­˜</button>
          <button class="btn btn-quit" onclick="quit()">ğŸšª çµ‚äº† (Q)</button>
        </div>

        <div class="keyboard-hint">
          ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: C=æ­£ã—ã„, W=é–“é•ã„, S=ã‚¹ã‚­ãƒƒãƒ—, Q=çµ‚äº†
        </div>
      </div>

      <div id="results-section" class="hidden">
        <div class="results-summary">
          <h2>âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†!</h2>
          <p id="final-summary"></p>
          <button class="btn btn-save" onclick="downloadResults()">
            çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
          <button class="btn btn-correct" onclick="backToExperiments()">
            å®Ÿé¨“é¸æŠã«æˆ»ã‚‹
          </button>
        </div>
      </div>
    </div>

    <script>
      let data = [];
      let shuffledData = [];
      let currentIndex = 0;
      let results = [];
      let totalItems = 0;
      let shuffleSeed = 12345;
      let currentExperiment = null;
      let experiments = {};

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
      const STORAGE_KEY = "llm_checker_experiments";

      // ã‚·ãƒ¼ãƒ‰å›ºå®šã®ç–‘ä¼¼ä¹±æ•°ç”Ÿæˆå™¨
      class SeededRandom {
        constructor(seed) {
          this.seed = seed;
        }

        next() {
          this.seed = (this.seed * 9301 + 49297) % 233280;
          return this.seed / 233280;
        }
      }

      // Fisher-Yates shuffle with seeded random
      function shuffleArray(array, seed) {
        const shuffled = [...array];
        const rng = new SeededRandom(seed);

        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(rng.next() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        return shuffled;
      }

      // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
      function saveExperiments() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(experiments));
      }

      // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
      function loadExperiments() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          experiments = JSON.parse(stored);
        }
      }

      // å®Ÿé¨“ä¸€è¦§ã®è¡¨ç¤º
      function displayExperiments() {
        const list = document.getElementById("experiment-list");
        list.innerHTML = "";

        Object.keys(experiments).forEach((expName) => {
          const exp = experiments[expName];
          const item = document.createElement("div");
          item.className = "experiment-item";
          item.textContent = `${expName} (${exp.checked_count}/${exp.total_items})`;
          item.onclick = () => selectExperiment(expName);

          if (currentExperiment === expName) {
            item.classList.add("selected");
          }

          list.appendChild(item);
        });
      }

      // å®Ÿé¨“é¸æŠ
      function selectExperiment(expName) {
        currentExperiment = expName;
        displayExperiments();

        const exp = experiments[expName];

        // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        currentIndex = exp.current_index;
        results = exp.results;
        shuffleSeed = exp.shuffle_seed;

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        shuffledData = shuffleArray(data, shuffleSeed);
        shuffledData.forEach((item, shuffledIndex) => {
          const originalIndex = data.findIndex((d) => d === item);
          item._originalIndex = originalIndex;
          item._shuffledIndex = shuffledIndex;
        });

        // UIæ›´æ–°
        document.getElementById("current-experiment-name").textContent =
          expName;
        document.getElementById("checked-items").textContent =
          exp.checked_count;
        document.getElementById("start-input").value = currentIndex + 1;
        document.getElementById("seed-input").value = shuffleSeed;

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById("experiment-section").classList.add("hidden");
        document
          .getElementById("data-loaded-section")
          .classList.remove("hidden");

        updateProgress();
      }

      // å®Ÿé¨“ä½œæˆ
      function createExperiment() {
        const name = document
          .getElementById("new-experiment-name")
          .value.trim();
        if (!name) {
          alert("å®Ÿé¨“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        if (experiments[name]) {
          alert("åŒã˜åå‰ã®å®Ÿé¨“ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™");
          return;
        }

        experiments[name] = {
          created_at: new Date().toISOString(),
          total_items: totalItems,
          checked_count: 0,
          current_index: 0,
          shuffle_seed: 12345,
          results: [],
        };

        saveExperiments();
        displayExperiments();
        document.getElementById("new-experiment-name").value = "";

        alert(`å®Ÿé¨“ã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
      }

      // å®Ÿé¨“å‰Šé™¤
      function deleteExperiment() {
        if (!currentExperiment) {
          alert("å‰Šé™¤ã™ã‚‹å®Ÿé¨“ã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }

        if (confirm(`å®Ÿé¨“ã€Œ${currentExperiment}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
          delete experiments[currentExperiment];
          saveExperiments();
          currentExperiment = null;
          displayExperiments();
        }
      }

      // å®Ÿé¨“é¸æŠã«æˆ»ã‚‹
      function backToExperiments() {
        document.getElementById("results-section").classList.add("hidden");
        document
          .getElementById("experiment-section")
          .classList.remove("hidden");
        displayExperiments();
      }

      // åˆæœŸåŒ–
      async function initialize() {
        try {
          const response = await fetch("test.json");
          if (!response.ok) {
            throw new Error("test.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          data = await response.json();
          totalItems = data.length;

          document.getElementById("total-items").textContent = totalItems;
          document.getElementById("total-items-2").textContent = totalItems;

          // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
          loadExperiments();

          // UIåˆ‡ã‚Šæ›¿ãˆ
          document.getElementById("loading-section").classList.add("hidden");
          document
            .getElementById("experiment-section")
            .classList.remove("hidden");

          displayExperiments();
        } catch (error) {
          document.getElementById(
            "loading-section"
          ).innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}<br>test.json ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„`;
        }
      }

      // å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      function reshuffle() {
        const newSeed = parseInt(document.getElementById("seed-input").value);
        if (newSeed !== shuffleSeed) {
          shuffleSeed = newSeed;
          shuffledData = shuffleArray(data, shuffleSeed);

          // ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
          shuffledData.forEach((item, shuffledIndex) => {
            const originalIndex = data.findIndex((d) => d === item);
            item._originalIndex = originalIndex;
            item._shuffledIndex = shuffledIndex;
          });

          // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
          if (currentExperiment) {
            experiments[currentExperiment].shuffle_seed = shuffleSeed;
            saveExperiments();
          }

          alert(`ã‚·ãƒ¼ãƒ‰å€¤ ${newSeed} ã§å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ`);
        }
      }

      // ãƒã‚§ãƒƒã‚¯é–‹å§‹
      function startChecking() {
        const newSeed = parseInt(document.getElementById("seed-input").value);
        if (newSeed !== shuffleSeed) {
          reshuffle();
        }

        const startPos =
          parseInt(document.getElementById("start-input").value) - 1;
        if (startPos >= 0 && startPos < totalItems) {
          currentIndex = startPos;

          // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
          if (currentExperiment) {
            experiments[currentExperiment].current_index = currentIndex;
            saveExperiments();
          }

          document
            .getElementById("data-loaded-section")
            .classList.add("hidden");
          document.getElementById("checker-section").classList.remove("hidden");
          displayCurrentItem();
          updateProgress();
        }
      }

      // ç¾åœ¨ã®é …ç›®ã‚’è¡¨ç¤º
      function displayCurrentItem() {
        if (currentIndex >= totalItems) {
          showResults();
          return;
        }

        const item = shuffledData[currentIndex];

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’è¡¨ç¤º
        const objectCaptions = document.getElementById("object-captions");
        objectCaptions.innerHTML = "";

        const captions = item.object_captions || {};
        let captionIndex = 1;
        for (const [objId, caption] of Object.entries(captions)) {
          const captionDiv = document.createElement("div");
          captionDiv.className = "object-caption";
          captionDiv.textContent = `${captionIndex}. ${caption}`;
          objectCaptions.appendChild(captionDiv);
          captionIndex++;
        }

        // ä¼šè©±ã‚’è¡¨ç¤º
        const conversations = document.getElementById("conversations");
        conversations.innerHTML = "";

        const convs = item.conversations || [];
        convs.forEach((conv) => {
          const convDiv = document.createElement("div");
          convDiv.className = "conversation";

          const isHuman = conv.from === "human";
          const messageDiv = document.createElement("div");
          messageDiv.className = isHuman ? "human-message" : "gpt-message";

          const roleLabel = document.createElement("div");
          roleLabel.className = "role-label";
          roleLabel.textContent = isHuman ? "ğŸ‘¤ äººé–“" : "ğŸ¤– GPT";

          const messageText = document.createElement("div");
          messageText.textContent = conv.value || "";

          messageDiv.appendChild(roleLabel);
          messageDiv.appendChild(messageText);
          convDiv.appendChild(messageDiv);
          conversations.appendChild(convDiv);
        });

        updateProgress();
      }

      // é€²æ—ã‚’æ›´æ–°
      function updateProgress() {
        const progress = ((currentIndex + 1) / totalItems) * 100;
        document.getElementById("progress-fill").style.width = progress + "%";

        let progressText = `é …ç›® ${
          currentIndex + 1
        }/${totalItems} (${progress.toFixed(1)}%)`;
        if (currentIndex < totalItems && shuffledData[currentIndex]) {
          const originalIndex = shuffledData[currentIndex]._originalIndex + 1;
          progressText += ` [å…ƒ: ${originalIndex}]`;
        }

        document.getElementById("progress-text").textContent = progressText;
      }

      // è©•ä¾¡
      function evaluate(evaluation) {
        const item = shuffledData[currentIndex];
        const result = {
          index: currentIndex,
          originalIndex: item._originalIndex,
          shuffledIndex: item._shuffledIndex,
          sample_id: item.metadata?.sample_id || "N/A",
          evaluation: evaluation,
          conversations: item.conversations || [],
          object_captions: item.object_captions || {},
          timestamp: new Date().toISOString(),
        };

        results.push(result);
        currentIndex++;

        // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        if (currentExperiment) {
          experiments[currentExperiment].results = results;
          experiments[currentExperiment].checked_count = results.length;
          experiments[currentExperiment].current_index = currentIndex;
          saveExperiments();
        }

        if (currentIndex < totalItems) {
          displayCurrentItem();
        } else {
          showResults();
        }
      }

      // çµæœã‚’ä¿å­˜
      function saveResults() {
        const resultsData = {
          experiment_name: currentExperiment,
          checked_items: results.length,
          total_items: totalItems,
          shuffle_seed: shuffleSeed,
          results: results,
        };

        const blob = new Blob([JSON.stringify(resultsData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${currentExperiment}_results.json`;
        a.click();
        URL.revokeObjectURL(url);

        alert("çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
      }

      // çµ‚äº†
      function quit() {
        if (confirm("ãƒã‚§ãƒƒã‚¯ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")) {
          showResults();
        }
      }

      // çµæœã‚’è¡¨ç¤º
      function showResults() {
        document.getElementById("checker-section").classList.add("hidden");
        document.getElementById("results-section").classList.remove("hidden");

        const summary = `å®Ÿé¨“ã€Œ${currentExperiment}ã€ã§åˆè¨ˆ ${results.length} ä»¶ã‚’è©•ä¾¡ã—ã¾ã—ãŸ`;
        document.getElementById("final-summary").textContent = summary;
      }

      // çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      function downloadResults() {
        saveResults();
      }

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
      document.addEventListener("keydown", function (e) {
        if (
          document
            .getElementById("checker-section")
            .classList.contains("hidden")
        ) {
          return;
        }

        switch (e.key.toLowerCase()) {
          case "c":
            evaluate("correct");
            break;
          case "w":
            evaluate("wrong");
            break;
          case "s":
            evaluate("skip");
            break;
          case "q":
            quit();
            break;
        }
      });

      // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      initialize();
    </script>
  </body>
</html>
